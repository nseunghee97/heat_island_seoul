---
title: "KOSPI 표 크롤링 과제"
author: "간정현"
date: 2019-04-06
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
**운영체제는 윈도우 10입니다.**



##**1. 필요한 라이브러리 가져오기**  


```{r library, message=FALSE}
library(tidyverse)
library(httr)
library(rvest)
library(stringr)
library(knitr)
```


##**2. 서버에 요청을 보내 응답을 받아오기**  


```{r get}
response <- GET(url = "https://finance.naver.com/sise/sise_index.nhn",
                query = list(code="KOSPI"))

print(response)
```


response 객체를 출력해보니 Status는 200으로 정상이고, 인코딩은 EUC-KR임을 확인할 수 있습니다.  


##**3. response 객체에서 html과 table을 뽑아내기**  


Sys.getlocale()로 현재 로케일을 확인해보니 초기값에서 변경되지 않은 상태입니다.  


```{r getlocale}
Sys.getlocale()
tbl <- read_html(x=response, encoding="EUC-KR") %>%
  html_node(css = "#contentarea_left > div.box_top_sub > div > div.subtop_sise_detail > table") %>%
  html_table(fill=FALSE)
print(tbl)
```


html_table() 함수에서 오류가 발생하지 않아 그대로 진행하였습니다. 웹 페이지에서 받아온 그대로의 tbl을 출력해보면 상당히 지저분한 형태입니다. 이 표를 분석하기 좋은 형태로 만들기 위해 변수 이름과 데이터를 분리해야 합니다.


##**4. 데이터 정리하기**


```{r cleaning_1}
attach(tbl)
values <- c(X2, X4); column_names <- c(X1, X3)
values[8] <- values[4]; values <- values[-4]
column_names[8] <- column_names[4]; column_names <- column_names[-4]

df_clean <- data.frame(matrix(seq(1:7),nrow=1))
columnnames_clean <- data.frame(matrix(seq(1:7),nrow=1))

count = 0
for (i in 1:4){
  df_clean[,i+count] <- values[i]; df_clean[,i+count+1] <- values[i+3]
  columnnames_clean[,i+count] <- column_names[i]; columnnames_clean[,i+count+1] <- column_names[i+3]
  count = count +1
}
colnames(df_clean) <- columnnames_clean; df_clean = df_clean[,-7]

print(df_clean)
```


대부분의 데이터는 정리되었지만 아직 마지막 컬럼에 데이터와 변수명이 분리되지 않은 채로 남아있습니다. 정규표현식을 이용해 변수 이름과 데이터를 분리합니다. 가장 먼저 공백을 제거하고, 다음으로는 숫자를 모두 추출하고, 마지막으로 숫자가 아닌 것들을 모두 추출합니다.  

```{r cleaning_2}
new_columns <- df_clean[1,7] %>% str_remove_all(pattern="[:space:]")
new_values <- str_extract_all(new_columns, pattern="\\d+",simplify=TRUE)
new_column_names <- str_extract_all(new_columns, pattern="[^\\d]+",simplify=TRUE)

for (i in 1:5){
  df_clean[1,i+6] <- new_values[i]
  names(df_clean)[i+6] <- new_column_names[i]
}

knitr::kable(df_clean, format="markdown")
```


표가 깔끔하게 정리되었습니다!  


##**4. 데이터테이블로 출력하기**  


정리된 표를 데이터테이블로 출력합니다.  


```{r show_datatable}
df_clean %>% DT :: datatable() 
```